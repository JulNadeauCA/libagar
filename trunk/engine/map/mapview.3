.\"	$Csoft: mapview.3,v 1.7 2005/06/17 08:37:50 vedge Exp $
.\"
.\" Copyright (c) 2002, 2003, 2004, 2005 CubeSoft Communications, Inc.
.\" <http://www.csoft.org>
.\" All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\" 
.\" THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
.\" IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
.\" WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
.\" ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,
.\" INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
.\" (INCLUDING BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
.\" SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
.\" HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
.\" STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING
.\" IN ANY WAY OUT OF THE USE OF THIS SOFTWARE EVEN IF ADVISED OF THE
.\" POSSIBILITY OF SUCH DAMAGE.
.\"
.Dd August 20, 2002
.Dt MAPEDIT 3
.Os
.ds vT Agar API Reference
.ds oS Agar 1.0
.Sh NAME
.Nm mapview
.Nd agar map display/edition widget
.Sh SYNOPSIS
.Bd -literal
#include <engine/map/mapview.h>
.Ed
.Sh DESCRIPTION
The
.Nm
widget displays a portion of a
.Xr map 3
structure.
.Nm
also offers an interface for different types of graphical edition tools.
.Pp
Although the edition interface was originally intended for tile-based level
edition tools, it was extended to include lower-level events, and is now used
by
.Xr vg 3
for the edition of vector graphics (in which case the
.Xr map 3
displayed by
.Nm
is generated by the raster engine).
.Sh INITIALIZATION
.nr nS 1
.Ft AG_Mapview *
.Fn AG_MapviewNew "void *parent" "AG_Map *map" "int flags" "AG_Toolbar *toolbar" "AG_Statusbar *statbar"
.Pp
.Ft void
.Fn AG_MapviewInit "AG_Mapview *mv" "AG_Map *map" "int flags" "AG_Toolbar *toolbar" "AG_Statusbar *statbar"
.Pp
.Ft void
.Fn AG_MapviewPrescale "AG_Mapview *mv" "int w" "int h"
.Pp
.Ft void
.Fn AG_MapviewSetScale "AG_Mapview *mv" "u_int zoom" "int adj_offs"
.nr nS 0
.Pp
The
.Fn AG_MapviewNew
function allocates, initializes, and attaches a
.Nm
widget.
The
.Fn AG_MapviewInit
function initializes a
.Nm
widget displaying the given
.Fa map .
The
.Fa flags
may include:
.Bd -literal
#define AG_MAPVIEW_EDIT	  0x01	/* Mouse/keyboard edition */
#define AG_MAPVIEW_GRID	  0x02	/* Display the grid */
#define MAPVIEW_PROPS	  0x04	/* Display node properties */
#define AG_MAPVIEW_CENTER	  0x08	/* Request initial centering */
#define AG_MAPVIEW_NO_CURSOR 0x10	/* Disable the cursor */
#define AG_MAPVIEW_NO_BMPSCALE 0x20	/* Disable bitmap scaling */
#define AG_MAPVIEW_NO_BG	   0x40	/* Disable background tiles */ 
#define AG_MAPVIEW_NO_NODESEL 0x80	/* Disable node selections */
.Ed
.Pp
If
.Fa toolbar
is not NULL, the
.Nm
will automatically create buttons in it for each tool registered with
.Fn AG_MapviewRegTool .
.Pp
The
.Dv AG_MAPVIEW_EDIT
flag enables write operations on the map, assuming the level editor,
.Xr mapedit 3 ,
is initialized.
.Pp
The
.Fn AG_MapviewPrescale
function arranges for the
.Nm
to reserve enough space to display
.Fa w
by
.Fa h
nodes at the initial sizing stage.
.Pp
The
.Fn AG_MapviewSetScale
function sets the scaling factor to
.Fa zoom ,
given in % of the default tile geometry.
If the
.Fa adj_offs
argument is nonzero, the camera is offset to preserve centering.
.Sh SELECTIONS
.nr nS 1
.Ft void
.Fn AG_MapviewSetSelection "AG_Mapview *mv" "int x" "int y" "int w" "int h"
.Pp
.Ft int
.Fn AG_MapviewGetSelection "AG_Mapview *mv" "int *x" "int *y" "int *w" "int *h"
.Pp
.nr nS 0
The
.Fn AG_MapviewSetSelection
function sets the active selection to
.Fa w
by
.Fa h
nodes at map position
.Fa x ,
.Fa y .
.Fn AG_MapviewSetSelection
also disables any mouse selection in progress.
.Pp
The
.Fn AG_MapviewGetSelection
returns 1 if there is an active selection or 0 if there is none.
If there is no selection, no value is written to
.Fa x ,
.Fa y ,
.Fa w
and
.Fa h .
.Sh EXTENSIONS
.nr nS 1
.Ft void
.Fn AG_MapviewRegTool "AG_Mapview *mv" "const AG_Maptool *toolspec" "void *arg"
.Pp
.Ft void
.Fn AG_MapviewSetDefaultTool "AG_Mapview *mv" "AG_Maptool *tool"
.Pp
.Ft void
.Fn AG_MapviewRegDrawCb "AG_Mapview *mv" "void (*f)(AG_MapView *mv, void *p)"
.nr nS 0
.Pp
The
.Nm
widget provides a generic interface for tools that must accomplish
diverse map operations.
.Fn AG_MapviewRegTool
registers a tool for use from a
.Nm .
.Fa toolspec
is assumed to point to a
.Ft tool
structure with the following fields properly initialized:
.Bd -literal
AG_Maptool {
	const char *name;		/* Name of the tool */
	const char *desc;		/* Short description */
	int icon;			/* Icon (-1 = none) */
	int cursor_index;		/* Static cursor (-1 = none) */

	void (*init)(AG_Maptool *t);
	void (*destroy)(AG_Maptool *t);
	int  (*load)(AG_Maptool *t, AG_Netbuf *b);
	int  (*save)(AG_Maptool *t, AG_Netbuf *b);
	int  (*cursor)(AG_Maptool *t, SDL_Rect *r);
	void (*effect)(AG_Maptool *t, AG_Node *n);
	int (*mousemotion)(AG_Maptool *t, int x, int y, int xrel,
	                  int yrel, int xo, int yo, int xorel,
			  int yorel, int button_state);
	int (*mousebuttondown)(AG_Maptool *t, int x, int y, int xoff,
	                       int yoff, int button);
	int (*mousebuttonup)(AG_Maptool *t, int x, int y, int xoff,
	                     int yoff, int button);
	int (*keydown)(AG_Maptool *t, int ksym, int kmod);
	int (*keyup)(AG_Maptool *t, int ksym, int kmod);
};
.Ed
.Pp
The
.Fn init ,
.Fn destroy ,
.Fn load
and
.Fn save
operations are used to initialize, free, save and restore any private data
structures needed by the tool.
.Pp
The
.Fn cursor
operation is expected to draw the current cursor at the screen coordinates
given by the
.Xr SDL_Rect
argument.
.Pp
The
.Fn effect
operation is executed on mouse click events, and on mouse motion events where
the relative map (node) coordinates are >|1|.
Typically, simple tools that perform node-specific operations such as the
.Sq stamp
and
.Sq eraser
tools will use this operation.
.Pp
Tools that perform more complex operations (such as vector graphics
manipulations) will generally use the lower-level
.Fn mousemotion ,
.Fn mousebuttondown ,
.Fn mousebuttonup ,
.Fn keydown
and
.Fn keyup
operations.
If any of these functions return a value of 1, the given event will not be
forwarded to the mouse/keyboard tool bindings and default operations.
.Pp
The
.Fn AG_MapviewSetDefaultTool
function configures a default tool which will receive all events that have
not been processed by the active tool or a mouse event binding.
.Pp
The
.Fn AG_MapviewRegDrawCb
function registers a function to invoke every time the
.Nm
widget is redrawn.
For instance, the
.Xr vg 3
subsystem uses this interface to register a function which performs
rasterization if the vector drawing's
.Va redraw
flag is set.
.Sh EVENTS
The
.Nm
widget reacts to the following events:
.Pp
.Bl -tag -width 25n
.It widget-lostfocus
Stop any zooming in progress.
.It window-mousebutton*
Forward the mouse button event to the active tool, if any.
If the active tool's handler routine returns != 1, the list of mouse bindings
is searched and matches are invoked, regardless of whether the given tool is
active or not.
Unless the mouse binding entry has the
.Va override
flag set, default actions apply.
.Pp
The default actions include selection of node elements (left click), popup
menu (middle click), panning (right click) and zooming (wheel up/down).
.It window-mousemotion
Scroll the view if panning is in progress.
If a rectangular selection is in progress, adjust the position relative to
the selection origin.
In edition mode, call current tool if the left mouse button is held.
.It window-keydown
The default key bindings are:
.Bl -tag -width "SDLK_EQUALS " -compact
.It Dv SDLK_EQUALS
Increment the zoom.
.It Dv SDLK_MINUS
Decrement the zoom.
.It Dv SDLK_[01]
Zoom to 1:1 (no scaling).
.It Dv SDLK_[2-9]
Zoom to a predefine value.
.It Dv SDLK_o
Center around the map origin.
.El
.It window-keyup
Stop any zooming in progress
.El
.Pp
The
.Nm
widget generates the following events:
.Pp
.Bl -tag -compact -width 2n
.It Fn mapview-dblclick "int button" "int x" "int y" "int xoff" "int yoff"
The user double clicked over the given tile.
.El
.Sh SEE ALSO
.Xr agar 3 ,
.Xr map 3 ,
.Xr mapedit 3 ,
.Xr vg 3 ,
.Xr widget 3 ,
.Xr window 3
.Sh HISTORY
The
.Nm
widget first appeared in Agar 1.0.
